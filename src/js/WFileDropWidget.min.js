WT_DECLARE_WT_MEMBER(1,JavaScriptConstructor,"WFileDropWidget",(function(e,t,n){t.wtLObj=this;const i=this,o=e.WT;let s="Wt-dropzone-hover";const l="Wt-dropzone-indication",r="Wt-dropzone-dragstyle",d=[];let a=!1,c=!0,u=!1,f=!1,p=!1,h=!1,m="file-selection",y=null,g=0,w=0;const v=document.createElement("input");v.type="file";v.setAttribute("multiple","multiple");v.style.display="none";t.hiddenInput=v;t.appendChild(v);const k=document.createElement("input");k.type="file";k.setAttribute("multiple","multiple");k.style.display="none";window.document.body.appendChild(k);t.serverFileInput=k;const b=document.createElement("input");b.type="file";b.setAttribute("multiple","multiple");b.setAttribute("webkitdirectory","webkitdirectory");b.style.display="none";window.document.body.appendChild(b);t.serverDirInput=b;const F=document.createElement("div");F.classList.add("Wt-dropcover");document.body.appendChild(F);this.validFileCheck=function(e,t,n){const i=new FileReader;i.onload=function(){t(!0,n,e)};i.onerror=function(){t(!1,n,e)};i.readAsText(e.file.slice(0,32))};t.setAcceptDrops=function(e){c=e};t.setAcceptDirectories=function(e,t){u=e;f=t};t.setDropIndication=function(e){p=e};t.setDropForward=function(e){h=e};t.ondragenter=function(e){if(c){if(function(e){const t=e.dataTransfer?.items??null,n=null!==t&&Array.prototype.some.call(t,(e=>"file"===e.kind)),i=e.dataTransfer?.types??null,o=null!==i&&i.includes("Files");return n||o}(e)){0===w&&i.setPageHoverStyle();w=2;i.setWidgetHoverStyle(!0)}e.stopPropagation()}};t.ondragleave=function(e){const t=e.clientX,n=e.clientY;let o=document.elementFromPoint(t,n);0===t&&0===n&&(o=null);if(o!==F)i.resetDragDrop();else{i.setWidgetHoverStyle(!1);w=1}};t.ondragover=function(e){e.preventDefault()};const S=function(e){if((p||h)&&"none"!==o.css(t,"display")&&c){w=1;i.setPageHoverStyle()}};document.body.addEventListener("dragenter",S);F.ondragover=function(e){e.preventDefault();e.stopPropagation()};F.ondragleave=function(e){c&&1===w&&i.resetDragDrop()};F.ondrop=function(e){e.preventDefault();h?t.ondrop(e):i.resetDragDrop()};t.ondrop=function(e){e.preventDefault();if(c){i.resetDragDrop();0!==e.dataTransfer.files.length&&i.addDataTransferItems(Array.from(e.dataTransfer.items))}};this.addDataTransferItems=async function(n){const i=[],o=n.map((e=>e.webkitGetAsEntry()));for(const e of o){const t=C(e);if(e.isFile){const n=await L(e);t.type=n.type;t.size=n.size;const i=W(n);t.id=i.id}else if(e.isDirectory){if(!u){console.warn("directory drop not enabled, ignoring entry",e);continue}t.contents=[];await D(e,t,f)}i.push(t)}if(0!==i.length){console.log("All newKeys: ",i);e.emit(t,"dropsignal",JSON.stringify(i))}};this.addFiles=function(n){const i=[];for(const e of n){const t=W(e),n={};n.id=t.id;n.filename=t.file.name;n.path=t.file.name;n.type=t.file.type;n.size=t.file.size;i.push(n)}e.emit(t,"dropsignal",JSON.stringify(i))};async function D(e,t,n){const i=await function(e){return new Promise((t=>{e.createReader().readEntries((function(e){t(e)}))}))}(e);for(let e=0;e<i.length;e++){const o=i[e],s=C(o);if(o.isFile){const e=await L(o);s.type=e.type;s.size=e.size;const t=W(e);s.id=t.id}else if(o.isDirectory){s.contents=[];n&&await D(o,s,n)}t.contents.push(s)}}function C(e){const t={};t.path=e.fullPath;t.filename=e.name;return t}function L(e){return new Promise((t=>{e.file((function(e){t(e)}))}))}function W(e){const t=new Object;t.id=Math.floor(Math.random()*Math.pow(2,31));t.file=e;d.push(t);return t}t.addEventListener("click",(function(){if(c&&"none"!==m){v.value="";v.click()}}));t.markForSending=function(e){for(const t of e){const e=t.id;for(const t of d)if(t.id===e){t.ready=!0;break}}a||d.length>0&&d[0].ready&&i.requestSend()};this.requestSend=function(){if(d[0].skip)i.uploadFinished(null);else{a=!0;e.emit(t,"requestsend",d[0].id)}};t.send=function(o,s){const l=d[0];if(l.file.size>n){e.emit(t,"filetoolarge",l.file.size);i.uploadFinished(null)}else if("boolean"==typeof t.wtUseCustomSend){if("function"!=typeof t.wtCustomSend)console.log("Warning: wtUseCustomSend is set, but wtCustomSend is not properly defined as a function. Falling back to the default upload mechanism");else if(t.wtUseCustomSend){i.validFileCheck(l,t.wtCustomSend,o);return}}else{const e=null!==y&&s?i.workerSend:i.actualSend;i.validFileCheck(l,e,o)}};this.actualSend=function(e,t,n){if(!e){i.uploadFinished(null);return}const o=new XMLHttpRequest;o.addEventListener("load",i.uploadFinished);o.addEventListener("error",i.uploadFinished);o.addEventListener("abort",i.uploadFinished);o.addEventListener("timeout",i.uploadFinished);o.open("POST",t);d[0].request=o;const s=new FormData;s.append("file-id",d[0].id);s.append("data",d[0].file);o.send(s)};this.workerSend=function(e,t,n){if(e){y.upload=d[0];y.postMessage({cmd:"send",url:t,upload:d[0],chunksize:g})}else i.uploadFinished(null)};this.uploadFinished=function(n){(null!=n&&"load"===n.type&&200===n.currentTarget.status||!0===n)&&e.emit(t,"uploadfinished",d[0].id);d.splice(0,1);if(d[0]&&d[0].ready)i.requestSend();else{a=!1;e.emit(t,"donesending")}};t.cancelUpload=function(e){if(d[0]&&d[0].id===e){d[0].skip=!0;d[0].request?d[0].request.abort():y&&y.upload===d[0]&&y.postMessage({cmd:"cancel",upload:d[0]})}else for(let t=1;t<d.length;t++)d[t].id===e&&(d[t].skip=!0)};const E=function(){c&&null!==this.files&&0!==this.files.length&&i.addFiles(this.files)};v.onchange=E;k.onchange=E;b.onchange=function(){if(!c)return;if(null===this.files||0===this.files.length)return;const n=[];for(let e=0;e<this.files.length;e++)A(n,this.files[e]);e.emit(t,"dropsignal",JSON.stringify(n))};function A(e,t){const n=t.webkitRelativePath,i=n.split("/");if(!f&&i.length>2)return;let o=null,s="";for(let t=0;t<i.length-1;t++){const n=i[t];s+="/"+n;const l=e.find((e=>e.path===s));if(l)o=l;else{const t={};t.path=s;t.filename=n;t.contents=[];null===o?e.push(t):o.contents.push(t);o=t}e=o.contents}const l={},r=W(t);l.id=r.id;l.path="/"+n;l.filename=t.name;l.type=t.type;l.size=t.size;o.contents.push(l)}this.setPageHoverStyle=function(){if(p||h){F.classList.add(r);t.classList.add(r);p&&t.classList.add(l)}};this.setWidgetHoverStyle=function(e){t.classList.toggle(s,e)};this.resetDragDrop=function(){t.classList.remove(l);t.classList.remove(r);F.classList.remove(r);i.setWidgetHoverStyle(!1);w=0};t.configureHoverClass=function(e){s=e};t.setFilters=function(e){v.setAttribute("accept",e);k.setAttribute("accept",e)};t.setUploadWorker=function(n){if(n&&window.Worker){y=new Worker(n);y.onmessage=function(n){if(n.data.workerfeatures){if("valid"!==n.data.workerfeatures){t.setUploadWorker(null);e.emit(t,"filternotsupported")}}else i.uploadFinished(n.data)};y.postMessage({cmd:"check"})}else y=null};t.setChunkSize=function(e){g=e};t.destructor=function(){document.body.removeEventListener("dragenter",S);document.body.removeChild(F)};t.setOnClickFilePicker=function(e){if("directory-selection"===e)t.hiddenInput.setAttribute("webkitdirectory","webkitdirectory");else{t.hiddenInput.removeAttribute("webkitdirectory");if("file-selection"!==e&&"none"!==e){console.warn("unknown filepicker type; using 'file-selection'",e);e="file-selection"}}m=e}}));